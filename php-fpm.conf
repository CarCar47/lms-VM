; ============================================================================
; PHP-FPM Pool Configuration for Moodle 5.1
; Optimized for Ubuntu 22.04 LTS with PHP 8.2
; Industry Standard Configuration
; ============================================================================
;
; This configuration optimizes PHP-FPM for Moodle workloads
; Recommended for use with Nginx (required) or Apache (optional)
;
; Installation:
;   1. Copy this file to: /etc/php/8.2/fpm/pool.d/moodle.conf
;   2. Disable default pool: mv /etc/php/8.2/fpm/pool.d/www.conf /etc/php/8.2/fpm/pool.d/www.conf.disabled
;   3. Test config: php-fpm8.2 -t
;   4. Restart PHP-FPM: systemctl restart php8.2-fpm
;
; Performance Tuning:
;   - Optimized for 2-4 vCPU, 4GB RAM systems
;   - Handles 40-200 concurrent Moodle users
;   - Adjust pm.* values based on your server resources
;
; ============================================================================

[moodle]

; ============================================================================
; POOL CONFIGURATION
; ============================================================================

; Pool name (used in logs)
; This appears in PHP-FPM logs to identify the pool
user = www-data
group = www-data

; Socket configuration
; Unix socket is faster than TCP for local connections
listen = /run/php/php8.2-fpm.sock

; Alternatively, use TCP socket (useful for distributed setups)
; listen = 127.0.0.1:9000

; Socket permissions
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; Allow connections from (for TCP socket)
; listen.allowed_clients = 127.0.0.1

; ============================================================================
; PROCESS MANAGER CONFIGURATION
; ============================================================================

; Process manager type
; dynamic = processes are spawned and killed based on load
; static = fixed number of processes (use for predictable load)
; ondemand = processes are spawned only when needed (saves RAM)
pm = dynamic

; Maximum number of child processes
; Formula: pm.max_children = Total RAM / Average process RAM
; For 4GB system with ~50MB per process: 4000MB / 50MB = 80 max
; Set to 40 for safety margin (allows OS and other processes)
pm.max_children = 40

; Number of child processes created on startup (for dynamic mode)
; Should be between min_spare_servers and max_spare_servers
pm.start_servers = 5

; Minimum number of idle processes
; Too low = slow response during traffic spikes
; Too high = wasted RAM
pm.min_spare_servers = 3

; Maximum number of idle processes
; Should be roughly: (pm.max_children / 2)
pm.max_spare_servers = 10

; Maximum number of requests each child process should execute before respawning
; Helps prevent memory leaks in long-running processes
; Moodle recommendation: 500-1000
pm.max_requests = 500

; ============================================================================
; PROCESS PRIORITY
; ============================================================================

; Process priority (nice value)
; Range: -19 (highest) to 20 (lowest)
; Default: no change (commented out)
; process.priority = -10

; ============================================================================
; TIMEOUTS
; ============================================================================

; Timeout for serving a single request
; Should match nginx fastcgi_read_timeout and php.ini max_execution_time
; Moodle admin tasks can take 5+ minutes
request_terminate_timeout = 300s

; Timeout for reading request from client
; request_slowlog_timeout = 30s

; ============================================================================
; PERFORMANCE TUNING
; ============================================================================

; Emergency restart threshold
; If this many child processes exit with SIGSEGV or SIGBUS within 1 minute,
; FPM will restart. 0 = disabled
emergency_restart_threshold = 10
emergency_restart_interval = 1m

; Time limit for child processes to wait for a reaction on signals from master
process_control_timeout = 10s

; ============================================================================
; LOGGING
; ============================================================================

; Slow request log
; Logs requests that take longer than request_slowlog_timeout
slowlog = /var/log/php8.2-fpm-slow.log
request_slowlog_timeout = 10s

; Access log
; access.log = /var/log/php8.2-fpm-access.log
; access.format = "%R - %u %t \"%m %r\" %s"

; ============================================================================
; ENVIRONMENT VARIABLES
; ============================================================================

; Clear environment variables
clear_env = no

; Pass environment variables to PHP
; Required for Moodle environment configuration
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

; Moodle-specific environment variables
env[MOODLE_DB_NAME] = $MOODLE_DB_NAME
env[MOODLE_DB_USER] = $MOODLE_DB_USER
env[MOODLE_DB_PASSWORD] = $MOODLE_DB_PASSWORD
env[MOODLE_DATAROOT] = $MOODLE_DATAROOT
env[MOODLE_WWWROOT] = $MOODLE_WWWROOT

; ============================================================================
; PHP CONFIGURATION OVERRIDES
; ============================================================================

; These override php.ini settings for this pool only
; Use php_admin_value for non-overridable settings
; Use php_value for user-overridable settings

; Memory limit (per request)
php_admin_value[memory_limit] = 512M

; Maximum execution time (seconds)
php_admin_value[max_execution_time] = 300

; Maximum upload size
php_admin_value[upload_max_filesize] = 100M
php_admin_value[post_max_size] = 100M

; Maximum input variables
php_admin_value[max_input_vars] = 5000

; Error reporting (production)
php_admin_value[display_errors] = Off
php_admin_value[display_startup_errors] = Off
php_admin_value[log_errors] = On
php_admin_value[error_log] = /var/log/php8.2-fpm-errors.log

; Session configuration
php_admin_value[session.save_handler] = files
php_admin_value[session.save_path] = /var/lib/php/sessions
php_admin_value[session.gc_maxlifetime] = 7200

; ============================================================================
; OPCACHE CONFIGURATION
; ============================================================================

; OPcache settings optimized for Moodle 5.1
; These match the php.ini settings but can be pool-specific
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 512
php_admin_value[opcache.max_accelerated_files] = 16229
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.validate_timestamps] = 1
php_admin_value[opcache.revalidate_freq] = 2
php_admin_value[opcache.save_comments] = 1
php_admin_value[opcache.fast_shutdown] = 1

; ============================================================================
; SECURITY
; ============================================================================

; Disable dangerous functions
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

; Open basedir restriction (limits file access)
; Allows access to Moodle directories only
; php_admin_value[open_basedir] = /var/www/html/moodle:/var/moodledata:/tmp:/usr/share/php

; Disable remote file access
php_admin_value[allow_url_fopen] = Off
php_admin_value[allow_url_include] = Off

; ============================================================================
; STATUS AND MONITORING
; ============================================================================

; Enable PHP-FPM status page
; Access at: http://yourdomain.com/php-fpm-status
pm.status_path = /php-fpm-status

; Enable PHP-FPM ping page (for health checks)
; Access at: http://yourdomain.com/php-fpm-ping
ping.path = /php-fpm-ping
ping.response = pong

; ============================================================================
; RESOURCE LIMITS
; ============================================================================

; Limit resources for this pool
; Requires systemd support

; Maximum number of file descriptors
; rlimit_files = 65536

; Maximum number of processes
; rlimit_core = unlimited

; ============================================================================
; SYSTEMD INTEGRATION
; ============================================================================

; Use systemd for process management (Ubuntu 22.04 default)
; systemd_interval = 10

; ============================================================================
; PERFORMANCE CALCULATION NOTES
; ============================================================================
;
; Memory Calculation:
;   - Average PHP-FPM process size: 30-70MB (depends on Moodle usage)
;   - Conservative estimate: 50MB per process
;   - For 4GB RAM system:
;     * Reserve 1GB for OS and MariaDB
;     * Available for PHP-FPM: 3GB
;     * Max processes: 3000MB / 50MB = 60 processes
;     * Set pm.max_children = 40 (safety margin)
;
; Process Manager Tuning:
;   - pm.start_servers = 5 (quick startup)
;   - pm.min_spare_servers = 3 (handle small traffic spikes)
;   - pm.max_spare_servers = 10 (don't waste RAM on idle processes)
;   - pm.max_requests = 500 (restart after 500 requests to prevent leaks)
;
; For Different Server Sizes:
;   - 2GB RAM: pm.max_children = 20, start_servers = 3, min_spare = 2, max_spare = 5
;   - 4GB RAM: pm.max_children = 40, start_servers = 5, min_spare = 3, max_spare = 10
;   - 8GB RAM: pm.max_children = 80, start_servers = 10, min_spare = 5, max_spare = 20
;   - 16GB RAM: pm.max_children = 150, start_servers = 20, min_spare = 10, max_spare = 40
;
; ============================================================================
; MONITORING COMMANDS
; ============================================================================
;
; Check PHP-FPM status:
;   systemctl status php8.2-fpm
;
; View active processes:
;   ps aux | grep php-fpm
;
; Monitor resource usage:
;   watch -n 1 'ps aux | grep php-fpm | grep -v grep | wc -l'
;   watch -n 1 'ps aux | grep php-fpm | grep -v grep | awk "{sum+=\$6} END {print sum/1024\" MB\"}"'
;
; View PHP-FPM status page (after configuring nginx/apache):
;   curl http://localhost/php-fpm-status
;   curl http://localhost/php-fpm-status?full
;   curl http://localhost/php-fpm-status?json
;
; Test PHP-FPM ping:
;   curl http://localhost/php-fpm-ping
;
; View slow log:
;   tail -f /var/log/php8.2-fpm-slow.log
;
; View error log:
;   tail -f /var/log/php8.2-fpm-errors.log
;
; ============================================================================
; TROUBLESHOOTING
; ============================================================================
;
; Problem: "502 Bad Gateway" errors
; Solution: Increase pm.max_children or reduce traffic
;
; Problem: High memory usage
; Solution: Reduce pm.max_children or pm.max_spare_servers
;
; Problem: Slow response times
; Solution: Increase pm.min_spare_servers and pm.max_spare_servers
;
; Problem: Frequent process restarts
; Solution: Increase pm.max_requests or check for memory leaks
;
; Problem: Socket permission errors
; Solution: Check listen.owner, listen.group, listen.mode match web server user
;
; ============================================================================
